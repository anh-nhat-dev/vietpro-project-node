<!DOCTYPE html>
<html lang="en">
  <head>
    <base href="/static/chat/" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="css/chat.css" />
  </head>
  <body>
    <div class="container app">
      <div class="row app-one">
        <div class="col-sm-4 side">
        
          <div class="side-one">
            <div class="row heading">
              <div class="col-sm-3 col-xs-3 heading-avatar">
                <div class="heading-avatar-icon">
                  <!-- <img src="img/avatar1.png" /> -->
                </div>
              </div>
               <div class="col-sm-1 col-xs-1  heading-dot  pull-right">
                <i class="fa fa-ellipsis-v fa-2x  pull-right" aria-hidden="true"></i>
              </div>
              <div class="col-sm-2 col-xs-2 heading-compose  pull-right">
                <i class="fa fa-comments fa-2x  pull-right" aria-hidden="true"></i>
              </div>
            </div>

            <div class="row searchBox">
              <div class="col-sm-12 searchBox-inner">
                <div class="form-group has-feedback">
                  <input
                    id="searchText"
                    type="text"
                    class="form-control"
                    name="searchText"
                    placeholder="Search"
                  />
                  <span
                    class="glyphicon glyphicon-search form-control-feedback"
                  ></span>
                </div>
              </div>
            </div>

            <div class="row sideBar">
            <% for (let room of rooms) { %>
            <div class="row sideBar-body" id="room-<%= room._id %>">
              <div class="col-sm-3 col-xs-3 sideBar-avatar">
                <div class="avatar-icon">
                  <img src="img/avatar1.png" />
                </div>
                
              </div>
              <div class="col-sm-9 col-xs-9 sideBar-main">
                <div class="row">
                  <div class="col-sm-8 col-xs-8 sideBar-name">
                    <span class="name-meta">
                      <%= room.name ? room.name : room.users.filter(u => u.id !== user._id).map(u => u.full_name).join(",") %>
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <% } %>
            </div>
          </div>

          <div class="side-two">
            <div class="row newMessage-heading">
              <div class="row newMessage-main">
                <div class="col-sm-2 col-xs-2 newMessage-back">
                  <i class="fa fa-arrow-left" aria-hidden="true"></i>
                </div>
                <div class="col-sm-10 col-xs-10 newMessage-title">New Chat</div>
              </div>
            </div>

            <div class="row composeBox">
              <div class="col-sm-12 composeBox-inner">
                <div class="form-group has-feedback">
                  <input
                    id="composeText"
                    type="text"
                    class="form-control"
                    name="searchText"
                    placeholder="Search People"
                  />
                  <span
                    class="glyphicon glyphicon-search form-control-feedback"
                  ></span>
                </div>
              </div>
            </div>

            <div class="row compose-sideBar" >

              <% for (let u of users) { %>

                <div class="row sideBar-body" id="user-<%= u._id %>">
                <div class="col-sm-3 col-xs-3 sideBar-avatar">
                  <div class="avatar-icon">
                    <img src="img/avatar1.png" />
                  </div>
                </div>
                <div class="col-sm-9 col-xs-9 sideBar-main">
                  <div class="row">
                    <div class="col-sm-8 col-xs-8 sideBar-name">
                      <span class="name-meta"><%= u.full_name %></span>
                    </div>
                  </div>
                </div>
              </div>

              <% } %>

              
            </div>
          </div>


        </div>

        <div class="col-sm-8 conversation">
          <div class="row heading">
            <div class="col-sm-2 col-md-1 col-xs-3 heading-avatar">
              <div class="heading-avatar-icon">
                <img src="img/avatar6.png" />
              </div>
            </div>
            <div class="col-sm-8 col-xs-7 heading-name">
              <a class="heading-name-meta">John Doe </a>
              <span class="heading-online">Online</span>
            </div>
            <div class="col-sm-1 col-xs-1 heading-dot pull-right">
              <i
                class="fa fa-ellipsis-v fa-2x pull-right"
                aria-hidden="true"
              ></i>
            </div>
          </div>

          <div class="row message" id="conversation">
            <div class="row message-previous">
              <div class="col-sm-12 previous">
                <a onclick="previous(this)" id="ankitjain28" name="20">
                  Show Previous Message!
                </a>
              </div>
            </div>

            <div class="row message-body">
              <div class="col-sm-12 message-main-receiver">
                <div class="receiver">
                  <div class="message-text">Hi, what are you doing?!</div>
                  <span class="message-time pull-right"> Sun </span>
                </div>
              </div>
            </div>

            <div class="row message-body">
              <div class="col-sm-12 message-main-sender">
                <div class="sender">
                  <div class="message-text">I am doing nothing man!</div>
                  <span class="message-time pull-right"> Sun </span>
                </div>
              </div>
            </div>
          </div>

          <div class="row reply">
            <div class="col-sm-1 col-xs-1 reply-emojis">
              <i class="fa fa-smile-o fa-2x"></i>
            </div>
            <div class="col-sm-9 col-xs-9 reply-main">
              <textarea class="form-control" rows="1" id="comment"></textarea>
            </div>
            <div class="col-sm-1 col-xs-1 reply-recording">
              <i class="fa fa-microphone fa-2x" aria-hidden="true"></i>
            </div>
            <div class="col-sm-1 col-xs-1 reply-send">
              <i class="fa fa-send fa-2x" aria-hidden="true"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        let current_room_id, current_user_id = `<%= user._id %>`;

        function startConversation(data){
          socket.emit("START_CONVERSATION", data)
        }

        function getMessage(){
          socket.emit("GET_MESSAGE", { id: current_room_id })
        }

        function newMessage() {
          const val = $("#comment").val();
          socket.emit("NEW_MESSAGE", {
            authorID: current_user_id,
            roomID: current_room_id,
            body: val
          });
          $("#comment").val("");
        }


        function renderRoom(room){
            const html = `<div class="row sideBar-body" id="room-${room._id}">
              <div class="col-sm-3 col-xs-3 sideBar-avatar">
                <div class="avatar-icon">
                  <img src="img/avatar1.png" />
                </div>
              </div>
              <div class="col-sm-9 col-xs-9 sideBar-main">
                <div class="row">
                  <div class="col-sm-8 col-xs-8 sideBar-name">
                    <span class="name-meta">
                      ${room.name ? 
                      room.name : 
                      room.users.filter(u => u._id !== current_user_id).map(u => u.full_name).join(",")}
                    </span>
                  </div>
                </div>
              </div>
            </div>`;

            $(".side-one .sideBar").prepend(html);
        }

        // Lắng nghe sự kiện từ javascript
        $(document).on("click", ".sideBar-body", function(e){
          // Lấy tham chiếu tới phần tử html được click dưới dạng jquery
          const self = $(this);
          // Lấy ra thuộc tính id của phần tử html
          const id_attr = self.attr("id");
          // Sử dụng split để  tách chuỗi id có dạng "type-id" 
          const [type, id] = id_attr.split("-");
          // Gửi một sự kiện lên server để thông báo cho server bắt đầu cuộc hội thoại
          startConversation({ type, id });
          // Trường hợp ở tab new message thì ẩn tab đi
          $(".newMessage-back").click();
        });
        
        $("#comment").on("keyup", function(){
           
          if (e.keyCode === 13) {
            // Nếu nhận shif + enter sẽ xuống dòng
            if (e.shiftKey) {
              inputElement.val(val + "\n");
              e.stopPropagation();
            } else if (val) {
              newMessage();
            }
          }
        })

        // Lắng nghe tự kiện từ server

        socket.on("START_CONVERSATION_SUCCESS", function(data){
          const room = data.room;
          // Set lại room hiện tại
          current_room_id = room._id;
          // Lấy ra danh sách message của room hiện tại
          getMessage();
          // Xóa các tin nhắn của hội thoại cũ
          $("#conversation").empty();
          // Xóa active room cũ
          $(".side-one").find(".active").removeClass("active");
          // Nếu room chưa tồn tại thì thêm mới vào HTMl
          if (!$(`#room-${room._id}`).length) {
            renderRoom(room)
          }
          // Active room hiện tại
          $(`#room-${room._id}`).addClass("active");
          
        });




    </script>

    <script>
      $(function () {
        $(".heading-compose").click(function () {
          $(".side-two").css({
            left: "0",
          });
        });

        $(".newMessage-back").click(function () {
          $(".side-two").css({
            left: "-100%",
          });
        });
      });
    </script>
  </body>
</html>
